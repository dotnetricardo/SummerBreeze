SummerBreeze
===========================

Metadata library and client-side entity generation script for BreezeJS for no DB, no EF ORM or EF ORM with DTO scenarios.


Instructions 
===========================
Section A)
Getting metadata and creating entities


On the server:
1 - Add reference to SummerBreeze.dll assembly.
2 - Decorate your POCOS (DTOs) with custom attributes (see https://github.com/dotnetricardo/SummerBreeze/wiki/Attributes for complete info)
ex:
   [BreezeLocalizable]
   [BreezeAutoGeneratedKeyType(SummerBreezeEnums.AutoGeneratedKeyType.Identity)]
    public class TodoItem {
    
    [Key]
    public int TodoItemId { get; set; }
    
    [Required] // this property is required and BreezeJS will assign a validation property to it
   [MaxLength(30)] // this property has also a MaxLength constraint so a maxlength validation property will be also created
    public string Title { get; set; }
    
    public bool IsDone { get; set; }

    public int TodoListId { get; set; }  // Foreign key

    // navigation property to item's parent TodoList
    [BreezeNavigationProperty("TodoList_Items", "TodoListId")] // 1st parameter is the association name and the 2nd the foreign key 
    public virtual TodoList TodoList { get; set; }

}





3 - Create a custom ContextProvider class that implements the ISummerBreezeDbContext.
ex:

    public class DTOContextProvider : ISummerBreezeDbContext
    {
        public Dictionary<Type, List<Breeze.WebApi.EntityInfo>> BeforeSaveEntities(Dictionary<Type, List<Breeze.WebApi.EntityInfo>> saveMap)
        {
            //implement custom behaviour here
            return saveMap;
        }

        public bool BeforeSaveEntity(Breeze.WebApi.EntityInfo entityInfo)
        {
            //implement custom behaviour here
            return true;
        }

        public List<Breeze.WebApi.KeyMapping> SaveChanges(Dictionary<Type, List<Breeze.WebApi.EntityInfo>> saveMap)
        {
            //implement custom save changes here
            throw new NotImplementedException();
        }


        public List<string> GetTrackedEntities()
        {
            var list = new List<string>();
            list.AddRange(new[] { "DTOModel" });

            return list;
        }
    }
    

4 - On your controller create an instance of SummerBreezeContextProvider and handle it the previous created contextprovider class. Choose one of two ways to initialize the class.
ex:

readonly SummerBreezeContextProvider<TodoContext> _summerBreezeContextProvider = new  SummerBreezeContextProvider<TodoContext>(); //don´t pass any parameter to the constructor if your models are in the same assembly of your project

or

readonly SummerBreezeContextProvider<TodoContext> _summerBreezeContextProvider = new SummerBreezeContextProvider<TodoContext>("DataLayer.dll"); //pass the assembly name to the constructor if your models reside in another referenced assembly


5 - Create a SummerBreezeMetadata method that returns a string and call the Metadata method of your SummerBreezaContextProvider and you´re done.
ex:
      [AcceptVerbs("GET")]
      public string SummerBreezeMetadata()
      {
          return _summerBreezeContextProvider.Metadata();
      }


On the client:
1 - Add reference to the summerbreeze.js script right after breeze.js and it´s dependencies.

2 - Create a generator instance from the global summerBreeze object by passing an initialization object with your service name, if saving queues are allowed and if entity saves are automatically processed once changes are detected.
ex:

var generator = new summerBreeze.generator( { service:'breeze/Todo'
                                                 enableQueing: true, //requires reference to breeze.savequeuing.js
                                                 autoSave: true }); //false if you want to manually call the breeze savechanges method


3- Call the generator generate method to create all the entity types and add them its internal breeze metadatastore. This method returns a promise that is useful if you have custom initialization options.
ex:
   generator.generate()
       .then(function () {
           registerCtors(); //if you have custom entity initialization logic register it here
       });
       
       
       
Section B)
Querying



On the server:
1 - Create a method on your controller that returns an IQueryable where T is the type of the DTO object you want to serialize to the client.
ex:

[AcceptVerbs("GET")]
      public IQueryable<DTOModel> DTOModels()
      {
          var list = new List<DTOModel>();
          list.Add(new DTOModel { 
              Id = 1,
              Name = "NumberOne",
              IsTestable = true
          });
          
           list.Add(new DTOModel
          {
              Id = 2,
              Name = "NumberTwo",
              IsTestable = false
          });

           return list.AsQueryable();
      }


On the client:
1 - Create a query with the normal breeze EntityQuery object.
ex:

var query = EntityQuery.from('DTOModels');


2 - Grab the manager object from the SummerBreeze generator and execute query.
ex:

var mgr = generator.manager;
mgr.executeQuery(query);



Section C)
Saving changes to entities

On the server:
1 - Create a SaveChanges method on your controller. 
   Remember if you´re using both EFContextProvider and SummerBreezeContextProvider to do some sort of logic to see which one to use. 
   In this example we´ve used the method on the ISummerBreezeDbContext GetTrackedEntities to return a list of the entities that where generated with SummerBreeze and use that context if a match is found.
   
ex:

[AcceptVerbs("POST")]
      public SaveResult SaveChanges(JObject saveBundle)
      {
         //check if object type exists with GetTrackedEntities 
          var counter = _summerBreezeContextProvider.GetTrackedEntities().Where(e => saveBundle["entities"].Any(t => t["entityAspect"]["entityTypeName"].ToString().Contains(e))).Count();

          if (counter > 0)
          {
           //SummerBreezeContextProvider   
           return _summerBreezeContextProvider.SaveChanges(saveBundle);
          }
          
           //EFContextProvider
          return _contextProvider.SaveChanges(saveBundle);
      }
      
      
On the client:
1 - Grab the manager object from the SummerBreeze generator and execute query.
ex:

var mgr = generator.manager;

2 - Create a new entity with the SummerBreeze manager.
ex:

var newDTO = mgr.createEntity('DTOModel', { Name: 'Acme', IsTestable: false });


3 - Save changes.
ex:

if (mgr.hasChanges()) {
                mgr.saveChanges();
            }




Comming soon
===========================
Commiting a demo solution to the repository.
